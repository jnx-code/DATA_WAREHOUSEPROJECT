-- here i do exploratory data analysis on my data

select * from information_schema.tables;
select * from information_schema.columns;
select distinct country from gold.dim_customers;
select distinct category,sub_category,product_name  from gold.dm_products;


select min(sales_order_date) as first_order_date from gold.fact_sales;
select max(sales_order_date) as first_order_date from gold.fact_sales;

select *,count(distinct sales ) from gold.fact_sales
group by sales;

SELECT product_key, COUNT(*) 
FROM gold.dm_products
GROUP BY product_key
HAVING COUNT(*) > 1
limit 5;
select product_name, count(*) from gold.dm_products
group by product_name
having count(*)>1
limit 5;


select 'total_sales' as measure_name, round(sum(price)) as measure_value from gold.fact_sales
union all
select 'total_quantity', sum(quantity) from gold.fact_sales
union all
select 'average_price',avg(price) from gold.fact_sales
union all
select 'totalnoorder',count(distinct order_number) from gold.fact_sales
union all
select 'product_total',count(product_name) from gold.dm_products
union all
select 'total_cust',count(customer_key) from gold.dim_customers;

select country,
count(customer_key) as total_customer
from gold.dim_customers
group by country;

SELECT 
  TRIM(UPPER(country)) AS clean_country
FROM gold.dim_customers
WHERE country IS NOT NULL AND country <> ''
GROUP BY TRIM(UPPER(country))
ORDER BY clean_country DESC;

select gender,count(customer_key) as total_customers
from gold.dim_customers
group by gender 
order by total_customers desc;

select category,count(product_key) as total_products
from gold.dm_products
group by category
order by total_products desc;

select category,avg(cost) as avg_cost
from gold.dm_products
group by category
order by avg_cost desc;

select 
p.category,
avg(f.sales) as total_revenue
from gold.fact_sales f
left join gold.dm_products p
on p.product_key = f.product_key
group by p.category
order by total_revenue desc;

select c.customer_key,
c.first_name,
c.last_name,
sum(f.sales) as total_revenue
from gold.fact_sales f
left join gold.dim_customers c
on c.customer_key = f.customer_key
group by 
 c.customer_key,
c.first_name,
c.last_name
order by total_revenue desc;

select 
c.country,
sum(f.quantity) as total_sold_item
from gold.fact_sales f
left join gold.dim_customers c
on c.customer_key = f.customer_key
group by c.country
order by total_sold_item desc;

-- which five products generate highest revenue 

select 
p.product_name,
avg(f.sales) as total_revenue
from gold.fact_sales f
left join gold.dm_products p
on p.product_key = f.product_key
group by p.product_name
order by total_revenue desc
limit 5;	
-- which product gave worst revenue 
select 
p.product_name,
avg(f.sales) as total_revenue
from gold.fact_sales f
left join gold.dm_products p
on p.product_key = f.product_key
group by p.product_name
order by total_revenue 
limit 5;	

select * from(
	select 
	p.product_name,
	avg(f.sales) as total_revenue,
	row_number() over (order by sum(f.sales) desc ) as rank_products
	from gold.fact_sales f
	left join gold.dm_products p
	on p.product_key = f.product_key
	group by p.product_name
) t where rank_products <= 5;
